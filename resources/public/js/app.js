// Generated by CoffeeScript 1.4.0
(function() {

  window.app = angular.module('app', []);

  app.config([
    '$routeProvider', function($routeProvider) {
      return $routeProvider.when('/', {
        templateUrl: '/templates/index.html',
        controller: app.IndexCtrl
      }).when('/port/:port', {
        templateUrl: '/templates/store.html',
        controller: app.StoreCtrl
      }).otherwise({
        redirectTo: '/'
      });
    }
  ]);

  /* --------------------------------------------
       Begin directives.coffee
  --------------------------------------------
  */


  app.directive('sparqlValue', function($rootScope) {
    return {
      template: "<span ng-show=\"literal\">{{v}}</span>\n<a href=\"#\" ng-click=\"explore(v)\" ng-hide=\"literal\">{{prefixed}}</a>",
      link: function(scope, element, attrs) {
        return scope.$watch(attrs.sparqlValue, function(value) {
          var prefix, uri, _ref;
          if (value) {
            if (value.type === "uri") {
              scope.literal = false;
              scope.v = value.value;
              _ref = $rootScope.prefixes;
              for (prefix in _ref) {
                uri = _ref[prefix];
                if (value.value.indexOf(uri) === -1) {
                  scope.prefixed = value.value;
                } else {
                  return scope.prefixed = value.value.replace(uri, prefix + ":");
                }
              }
            } else {
              scope.v = value.value;
              return scope.literal = true;
            }
          }
        });
      }
    };
  });

  app.directive('prefixesArea', function($rootScope) {
    return {
      template: "<div ng-repeat=\"(prefix, uri) in prefixes\">test {}</div>",
      link: function(scope, element, attrs) {}
    };
  });

  /* --------------------------------------------
       Begin services.coffee
  --------------------------------------------
  */


  app.factory('FourstoreService', function($http) {
    var FourstoreService;
    return new (FourstoreService = (function() {

      function FourstoreService() {}

      FourstoreService.prototype.get = function(port, query, callback) {
        return $http({
          method: "GET",
          url: "/api/get",
          params: {
            query: query,
            endpoint: "http://localhost:" + port
          }
        }).success(callback);
      };

      FourstoreService.prototype.post = function(port, query, callback) {
        return $http({
          method: "POST",
          url: "/api/post",
          data: {
            query: query,
            endpoint: "http://localhost:" + port
          }
        }).success(callback);
      };

      return FourstoreService;

    })());
  });

  /* --------------------------------------------
       Begin controllers.coffee
  --------------------------------------------
  */


  app.IndexCtrl = function($scope, FourstoreService, $location) {
    $scope.port = 8010;
    return $scope.open4store = function(port) {
      return $location.path("/port/" + port);
    };
  };

  app.StoreCtrl = function($scope, $routeParams, $rootScope, $timeout, FourstoreService) {
    var get, post, sparqlEditor,
      _this = this;
    sparqlEditor = null;
    $scope.port = $routeParams.port;
    $rootScope.getQuery = "SELECT *\nWHERE {\n  ?s ?p ?o\n}\nLIMIT 10";
    $rootScope.postQuery = "INSERT {\n  GRAPH <> {\n    <> <> <> .\n  }\n}";
    $timeout(function() {
      return sparqlEditor = CodeMirror.fromTextArea(angular.element('.sparql-query')[0], {
        theme: "elegant"
      });
    }, 0);
    $scope.method = "get";
    $scope.changeQuery = function(method) {
      event.preventDefault();
      $scope.method = method;
      if (method === "get") {
        sparqlEditor.setValue($rootScope.getQuery);
      } else {
        sparqlEditor.setValue($rootScope.postQuery);
      }
      return $(event.target).tab('show');
    };
    $scope.run = function() {
      var query;
      query = $('.prefixes-area').text() + "\n" + sparqlEditor.getValue();
      if ($scope.method === "get") {
        $rootScope.getQuery = sparqlEditor.getValue();
        return get(query);
      } else {
        $rootScope.postQuery = sparqlEditor.getValue();
        return post(query);
      }
    };
    get = function(query) {
      return FourstoreService.get($scope.port, query, function(response) {
        if (response.status === 200) {
          $scope.results = JSON.parse(response.body);
          angular.element("#tabs-results li:eq(0) a").tab('show');
          return Alertify.log.success("showing results");
        } else {
          return Alertify.log.error('no success');
        }
      });
    };
    post = function(query) {
      return FourstoreService.post($scope.port, query, function(response) {
        if (response.status === 200) {
          get();
          return Alertify.log.success("update successed");
        } else {
          return Alertify.log.error('no success');
        }
      });
    };
    return $scope.explore = function(v) {
      event.preventDefault();
      angular.element("#tabs-results li:eq(1) a").tab('show');
      FourstoreService.get($scope.port, "SELECT ?predicate ?object ?graph\nWHERE {\n  GRAPH ?graph {\n    <" + v + "> ?predicate ?object .\n  }\n}", function(res) {
        if (res.status === 200) {
          return $scope.po = JSON.parse(res.body);
        }
      });
      FourstoreService.get($scope.port, "SELECT ?subject ?object ?graph\nWHERE {\n  GRAPH ?graph {\n    ?subject <" + v + "> ?object .\n  }\n}", function(res) {
        if (res.status === 200) {
          return $scope.so = JSON.parse(res.body);
        }
      });
      return FourstoreService.get($scope.port, "SELECT ?subject ?predicate ?graph\nWHERE {\n  GRAPH ?graph {\n    ?subject ?predicate <" + v + "> .\n  }\n}", function(res) {
        if (res.status === 200) {
          return $scope.sp = JSON.parse(res.body);
        }
      });
    };
  };

  app.PrefixesCtrl = function($scope, $rootScope) {
    var sparqlPrefixes;
    $scope.tes = "eee";
    $rootScope.prefixes = {
      'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
      'rdfs': 'http://www.w3.org/2000/01/rdf-schema#',
      'dc11': 'http://purl.org/dc/elements/1.1/',
      'skos': 'http://www.w3.org/2004/02/skos/core#',
      'foaf': 'http://xmlns.com/foaf/0.1/',
      'schema': 'http://schema.org/'
    };
    $rootScope.$watch("prefixes", function(value) {
      return $scope.prefixesStr = sparqlPrefixes(value);
    });
    $scope.addPrefix = function(prefix, uri) {
      console.log(prefix, uri);
      if (prefix && uri) {
        $rootScope.prefixes[prefix] = uri;
        if (!$rootScope.$$phase) {
          return $rootScope.$apply();
        }
      }
    };
    $scope.modifyPrefix = function(prefix, idx) {
      $rootScope.prefixes[prefix] = $("#uri-" + idx).val();
      if (!$rootScope.$$phase) {
        return $rootScope.$apply();
      }
    };
    $scope.deletePrefix = function(prefix) {
      return delete $rootScope.prefixes[prefix];
    };
    return sparqlPrefixes = function(prefixes) {
      return _.map(prefixes, function(prefix, uri) {
        return "PREFIX " + prefix + ": <" + uri + "> ";
      }).join("\n");
    };
  };

}).call(this);
